<!DOCTYPE html>
<html lang="es">
<head>
  <!-- Google Tag Manager -->
<script>
  (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MCPMM9QB');</script>
<!-- End Google Tag Manager -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vida RPG — Visual</title>
  <style>
    :root {
      --bg: #0c111f;
      --card: #1b2434;
      --accent1: #6ea8fe;
      --accent2: #44c8db;
      --text: #e6eef8;
      --muted: #8ca3b1;
      --shadow: 0 8px 24px rgba(0,0,0,0.7);
      --radius: 14px;
      
      --bar-bg: var(--bg);  
      --stat-fue: #f44336;
      --stat-int: #2196F3;
      --stat-des: #4caf50;
      --stat-car: #ff9800;
    }
    * { box-sizing: border-box; margin:0; padding:0; }
    body {<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MCPMM9QB"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
      background: var(--bg);
      color: var(--text);
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      padding: 20px;
    }
    .container {
      width: 100%;
      max-width: 1000px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    header h1 {
      font-size: 28px;
      color: var(--accent1);
    }
    .tabs {
      display: flex;
      gap: 10px;
      flex-wrap: wrap; /* Para que quepan más pestañas */
    }
    .tab {
      padding: 8px 16px;
      background: var(--card);
      border-radius: var(--radius);
      cursor: pointer;
      transition: background 0.3s;
    }
    .tab.active {
      background: var(--accent1);
      color: var(--bg);
    }
    main {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 20px;
    }
    aside {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
    }
    .player-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .player-name {
      font-size: 24px;
      font-weight: bold;
      color: var(--accent2);
    }
    .stat {
      margin-top: 12px;
    }
    .stat label {
      font-size: 14px;
      color: var(--muted);
    }
    .stat .value {
      font-size: 20px;
    }
    
    .log {
      max-height: 180px;
      overflow-y: auto;
      background: var(--bar-bg); 
      border: 1px solid var(--card); 
      border-radius: var(--radius);
      padding: 10px;
      font-size: 14px;
      line-height: 1.4;
    }
    
    .table-wrapper {
      overflow-x: auto; /* Permite scroll horizontal */
    }
    
    table {
      width: 100%;
      min-width: 800px; /* Ancho mínimo para que no se comprima */
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 14px;
    }
    table th, table td {
      padding: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      text-align: left;
      white-space: nowrap; /* Evita que el texto se rompa */
    }
    
    table th:nth-child(2), table td:nth-child(2) {
      white-space: normal; /* Permite que la descripción se rompa si es muy larga */
    }

    table input[type="text"] {
      background: var(--bg);
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--text);
      padding: 4px;
      border-radius: 6px;
      font-size: 14px;
      width: 100%; 
      min-width: 300px; /* Ancho mínimo para el input */
    }
     table select {
      background: var(--bg);
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--text);
      padding: 4px;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .button {
      margin-top: 12px;
      padding: 10px 18px;
      border: none;
      border-radius: var(--radius);
      background: var(--accent1);
      color: var(--bg);
      cursor: pointer;
      transition: background 0.3s;
      margin-right: 5px; 
    }
    .button:hover {
      background: var(--accent2);
    }
    .button:disabled {
      background: var(--muted);
      cursor: not-allowed;
    }
    
    .difficulty {
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: bold;
      color: #fff;
      text-shadow: 1px 1px 1px rgba(0,0,0,0.2);
      display: inline-block;
    }
    .difficulty-Facil { background: #4caf50; } 
    .difficulty-Media { background: #ff9800; } 
    .difficulty-Dificil { background: #f44336; } 
    .difficulty-Epica { background: #9c27b0; } 
    
    /* --- CSS Logros --- */
    .achievements-list {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 15px;
    }
    .achievement-card {
      background: var(--bg);
      border: 1px solid var(--card);
      border-radius: var(--radius);
      padding: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
      opacity: 0.5;
      transition: all 0.3s;
    }
    .achievement-card.unlocked {
      opacity: 1;
      border-color: var(--accent2);
    }
    /* Logro Oculto */
    .achievement-card.hidden-ach {
      opacity: 1;
      border-color: var(--stat-car);
    }
    .achievement-card.hidden-ach .achievement-icon {
      filter: blur(4px);
    }
    .achievement-card.hidden-ach.unlocked .achievement-icon {
      filter: none;
    }
    .achievement-card.hidden-ach.unlocked h3 {
      color: var(--stat-car);
    }
    
    /* --- CSS HÁBITOS --- */
    .habits-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 15px;
    }
    .habit-card {
      background: var(--bg);
      border: 1px solid var(--card);
      border-radius: var(--radius);
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .habit-details h3 { font-size: 18px; }
    .habit-details p { font-size: 14px; color: var(--muted); }
    .habit-controls { display: flex; align-items: center; gap: 10px; }
    .habit-count { font-size: 20px; font-weight: bold; min-width: 30px; text-align: center; }
    .habit-btn {
      font-size: 20px;
      font-weight: bold;
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--accent1);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
      line-height: 28px;
    }
    .habit-btn.minus { border-color: #f44336; }
    
    /* --- CSS HABILIDADES --- */
    .skills-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .attribute-tree {
      background: var(--bg);
      border: 1px solid var(--card);
      border-radius: var(--radius);
      padding: 15px;
    }
    .attribute-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--card);
    }
    .attribute-header h3 { font-size: 20px; }
    .attribute-header h3.fue { color: var(--stat-fue); }
    .attribute-header h3.int { color: var(--stat-int); }
    .attribute-header h3.des { color: var(--stat-des); }
    .attribute-header h3.car { color: var(--stat-car); }
    .attribute-points-spend {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .attribute-points-spend span { font-size: 22px; font-weight: bold; }
    .skill-list { margin-top: 15px; display: flex; flex-direction: column; gap: 10px; }
    .skill {
      opacity: 0.4;
      border-left: 3px solid var(--muted);
      padding-left: 10px;
    }
    .skill.unlocked {
      opacity: 1;
      border-left-color: var(--accent2);
    }
    .skill.can-buy {
      opacity: 1;
      cursor: pointer;
      border-left-color: var(--accent1);
    }
    .skill.can-buy:hover { background: rgba(255,255,255,0.1); }
    .skill h4 { font-size: 15px; }
    .skill p { font-size: 13px; color: var(--muted); }
    
    /* --- CSS EQUIPAMIENTO --- */
    .equipment-slots {
      margin-top: 20px;
      border-top: 1px solid var(--card);
      padding-top: 15px;
    }
    .equipment-slot {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      margin-top: 8px;
    }
    .equipment-slot .name { color: var(--muted); }
    .equipment-slot .item { color: var(--accent2); font-weight: bold; }
    
    /* --- CSS PROYECTOS --- */
    .project-card {
      background: var(--bg);
      border: 1px solid var(--card);
      border-radius: var(--radius);
      padding: 15px;
      margin-top: 15px;
    }
    .project-card h3 { color: var(--accent2); }
    .project-card p { font-size: 14px; color: var(--muted); margin-top: 4px; }
    .progress-bar {
      height: 24px;
      background: var(--bg);
      border-radius: var(--radius);
      overflow: hidden;
      margin-top: 10px;
      border: 1px solid var(--card);
    }
    .progress-bar-inner {
      height: 100%;
      width: 0%;
      background: var(--stat-des);
      transition: width 0.5s;
      text-align: center;
      line-height: 24px;
      font-size: 12px;
      font-weight: bold;
      color: var(--bg);
    }
    
    /* --- CSS OBSTÁCULO --- */
    #obstacle-widget {
      display: none; /* Oculto por defecto */
    }
    .obstacle-card {
      border: 2px solid var(--stat-fue);
      padding: 15px;
    }
    .obstacle-card h3 { color: var(--stat-fue); font-size: 18px; }
    .obstacle-card p { font-size: 14px; margin-top: 4px; }
    
    /* --- CSS COMPAÑERO --- */
    .companion-header {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .companion-icon {
      font-size: 64px;
      line-height: 1;
    }
    .companion-name {
      font-size: 24px;
      font-weight: bold;
    }
    .rarity-Común { color: var(--muted); }
    .rarity-Poco-Común { color: var(--stat-car); }
    .rarity-Raro { color: var(--accent1); }
    .rarity-Épico { color: #d158d1; }
    
    .energy-bar {
      height: 10px;
      background: var(--bg);
      border-radius: var(--radius);
      overflow: hidden;
      margin-top: 6px;
      border: 1px solid var(--card);
    }
    .energy-bar-inner {
      height: 100%;
      width: 0%;
      background: var(--stat-des);
      transition: width 0.5s;
    }
    
    /* --- CSS MIMAR GATO --- */
    .mimar-section {
      margin-top: 20px;
      border-top: 1px solid var(--card);
      padding-top: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    /* --- CSS CASINO --- */
    .casino-game {
      text-align: center;
      padding: 20px;
    }
    .casino-game .pot {
      font-size: 48px;
      font-weight: bold;
      color: var(--stat-des);
      margin: 10px 0;
    }
    .casino-game .round {
      font-size: 20px;
      color: var(--accent2);
    }
    .casino-actions {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
    }
    
    
    footer {
      margin-top: 30px;
      text-align: center;
      font-size: 13px;
      color: var(--muted);
    }
    @media (max-width: 800px) {
  body {
    padding: 10px; /* Menos padding en el body */
  }
  main {
    grid-template-columns: 1fr; /* Coloca la barra lateral encima del contenido */
  }
  .card {
    padding: 15px; /* Menos padding en las tarjetas */
  }
  header {
    flex-direction: column; /* Apila el título y las pestañas */
    gap: 15px;
  }
  .tabs {
    justify-content: center; /* Centra las pestañas */
  }
  .tab {
    padding: 6px 12px; /* Pestañas un poco más pequeñas */
    font-size: 14px;
  }

  /* Botones más grandes y apilados */
  .button {
    width: 100%; /* Ocupan todo el ancho */
    padding: 12px;
    margin-top: 10px;
    margin-right: 0;
  }

  /* Ajustes de tablas */
  table input[type="text"] {
    min-width: 200px; /* Inputs más pequeños en la tabla */
  }

  /* Apilar listas de 2 columnas */
  .achievements-list, .skills-container {
    grid-template-columns: 1fr;
  }

  /* Apilar botones del casino */
  .casino-actions {
    flex-direction: column;
  }

  /* Apilar sección de mimar gato */
  .mimar-section {
    flex-direction: column;
    align-items: flex-start;
  }

  /* Área del minijuego más pequeña */
  #minigame-area {
    height: 250px;
  }
}
    /* --- CSS MINI-JUEGO --- */
#minigame-container {
  text-align: center;
}
#minigame-area {
  position: relative;
  width: 100%;
  height: 300px;
  background: var(--bg);
  border: 1px solid var(--card);
  border-radius: var(--radius);
  margin-top: 15px;
  overflow: hidden;
}
#minigame-toy {
  position: absolute;
  width: 50px;
  height: 50px;
  background-color: var(--stat-car);
  border-radius: 50%;
  cursor: pointer;
  display: none;
  font-size: 28px;
  line-height: 50px;
  text-align: center;
  transition: all 0.1s;
}
#minigame-toy:hover {
  transform: scale(1.1);
}
#minigame-status {
  margin-top: 10px;
  font-size: 18px;
  color: var(--accent2);
}

  </style>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>🔮 Vida RPG</h1>
      <div class="tabs" id="tabs"></div>
    </header>
    <main>
      <aside>
        <div class="card">
          <div class="player-header">
            <div class="player-name" id="player-name">Player</div>
            <div class="player-level">Lvl <span id="player-level">1</span></div>
          </div>
          <div class="stat">
            <label>HP</label>
            <div class="value" id="player-hp">100 / 100</div>
          </div>
          <div class="stat">
            <label>XP</label>
            <div class="value" id="player-xp">0 / 100</div>
          </div>
          <div class="stat">
            <label>Créditos</label>
            <div class="value" id="player-credits">0</div>
          </div>
          <div class="stat">
            <label>Puntos de Atributo (PA)</label>
            <div class="value" id="player-pa" style="color: var(--accent2);">0</div>
          </div>
        </div>
        
        <div id="obstacle-widget" class="card obstacle-card"></div>
        
        <div class="card">
          <div class="stat">
            <label>📝 Diario de aventuras</label>
          </div>
          <div class="log" id="diary"></div>
        </div>
      </aside>
      <section>
        <div class="card" id="tab-content"></div>
      </section>
    </main>
    <footer>Reproducción visual de tu hoja de Google Sheets — “Vida RPG”</footer>
  </div>

  <script>
     // --- INICIALIZACIÓN DE FIREBASE ---
// ¡¡PEGA TU CÓDIGO 'firebaseConfig' DE FIREBASE AQUÍ!!
const firebaseConfig = {
   apiKey: "AIzaSyB-WpVyjAgZEHyfqZ9caHaS9vEQbpjSX8I",
  authDomain: "vida-rpg-f2dbf.firebaseapp.com",
  projectId: "vida-rpg-f2dbf",
  storageBucket: "vida-rpg-f2dbf.firebasestorage.app",
  messagingSenderId: "273885218531",
  appId: "1:273885218531:web:41367ac017df3c15e667d6",
  measurementId: "G-NL9EXH9GS3"
};
// Inicializar Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore(); // Esta es nuestra conexión a la base de datos
// --- FIN DE INICIALIZACIÓN DE FIREBASE ---
  // --- CONFIGURACIÓN ---
  const DIFFICULTY_REWARDS = {
    "Facil": { xp: 50, credits: 10, cooldownHours: 8 },
    "Media": { xp: 100, credits: 20, cooldownHours: 12 },
    "Dificil": { xp: 420, credits: 30, cooldownHours: 24 },
    "Epica": { xp: 1000, credits: 75, cooldownHours: 168 }
  };
  
  // --- LISTA DE EVENTOS (AHORA INTERACTIVOS) ---
const RANDOM_EVENTS = [
  // --- Evento 1 ---
  { 
    type: 'interactive',
    text: "Caminando, ves un gatito asustado en un árbol. ¡No puede bajar!",
    options: [
      { stat: 'fue', text: "Intentar trepar al árbol por la fuerza." },
      { stat: 'des', text: "Usar una escalera cercana con agilidad." },
      { stat: 'int', text: "Trazar un plan para atraerlo con comida." },
      { stat: 'car', text: "Calmar al gato con tu voz para que baje." }
    ],
    success_text: "¡Lo lograste! El dueño te ve y te da una recompensa.",
    fail_text: "¡Fallaste! El gato te araña y huye.",
    success_reward: { xp: 30, credits: 15 },
    fail_penalty: { hp: -5 }
  },
  // --- Evento 2 ---
  { 
    type: 'interactive',
    text: "Un mercader ambulante te ofrece un 'ítem misterioso' a un precio 'justo'.",
    options: [
      { stat: 'car', text: "Regatear el precio usando tu encanto." },
      { stat: 'int', text: "Evaluar el ítem en busca de señales de estafa." },
      { stat: 'des', text: "Intentar tomarlo y correr (¡arriesgado!)." },
      { stat: 'fue', text: "Intimidar al mercader para que baje el precio." }
    ],
    success_text: "¡Funciona! El mercader cede y te lo da más barato.",
    fail_text: "No funciona. El mercader se ofende y sube el precio.",
    success_reward: { xp: 10, credits: -10 }, // Ganas XP pero pagas
    fail_penalty: { credits: -25 } // Pagas más
  },
  // --- Evento 3 ---
  { 
    type: 'interactive',
    text: "Ves un cofre viejo y cerrado en un callejón.",
    options: [
      { stat: 'fue', text: "Romper el candado a la fuerza." },
      { stat: 'des', text: "Intentar forzar la cerradura con agilidad." },
      { stat: 'int', text: "Examinar el cofre en busca de un mecanismo oculto." },
      { stat: 'car', text: "Preguntar al dueño de la tienda cercana si sabe la combinación." }
    ],
    success_text: "¡Se abre! Dentro encuentras un pequeño tesoro.",
    fail_text: "¡Haces mucho ruido! El candado no cede y tienes que irte.",
    success_reward: { xp: 10, credits: 40 },
    fail_penalty: { hp: 0 }
  },
  // --- Evento 4 ---
  { 
    type: 'interactive',
    text: "Estás en una cafetería y dos personas discuten en la mesa de al lado. La situación es tensa.",
    options: [
      { stat: 'fue', text: "Ponerte en medio con autoridad para intimidarlos." },
      { stat: 'des', text: "Derramar 'accidentalmente' un vaso de agua para distraerlos." },
      { stat: 'int', text: "Analizar la discusión y proponer una solución lógica." },
      { stat: 'car', text: "Intervenir amablemente y mediar en la conversación." }
    ],
    success_text: "Logras calmar la situación. El dueño te invita a un café.",
    fail_text: "Empeoras las cosas. Te gritan y tienes que irte.",
    success_reward: { xp: 25, hp: 5 },
    fail_penalty: { hp: -5 }
  },
  // --- Evento 5 ---
  { 
    type: 'interactive',
    text: "Un perro grande te bloquea el camino en un callejón, gruñendo.",
    options: [
      { stat: 'fue', text: "Plantarle cara y gritarle para asustarlo." },
      { stat: 'des', text: "Esquivarlo rápidamente y saltar una valla cercana." },
      { stat: 'int', text: "Quedarte quieto, evitando el contacto visual (comportamiento canino)." },
      { stat: 'car', text: "Hablarle en tono calmado y suave para tranquilizarlo." }
    ],
    success_text: "El perro se relaja y te deja pasar, moviendo la cola.",
    fail_text: "El perro se altera más y te muerde el tobillo.",
    success_reward: { xp: 30 },
    fail_penalty: { hp: -10 }
  },

  // --- Eventos Especiales (LOS MANTENEMOS) ---
  { type: 'obstacle', text: "Sientes un bloqueo mental... ¡Un Obstáculo ha aparecido!", obstacle: "Procrastinación" },
  { type: 'mission', text: "¡Un NPC te pide ayuda urgente!", mission: { title: "(EVENTO) Ayuda rápida", difficulty: "Facil", projectLink: null } }
];

  
  const OBSTACLES = {
    "Procrastinación": { name: "Procrastinación", hp: 300, debuff: { type: 'xp_reduction', value: 0.25 }, description: "Efecto: -25% XP de todas las misiones." }
  };
  
  const SKILL_TREE = {
    fue: [
      { id: 'f1', req: 15, title: "Fortaleza", desc: "Pasivo: +20 HP Máximo." }
    ],
    int: [
      { id: 'i1', req: 15, title: "Erudito", desc: "Pasivo: +10% XP de todas las misiones." }
    ],
    des: [
      { id: 'd1', req: 15, title: "Comerciante", desc: "Pasivo: +10% Créditos de todas las misiones." }
    ],
    car: [
      { id: 'c1', req: 15, title: "Carisma", desc: "Pasivo: -10% de precios en la Tienda." }
    ]
  };
  
  // --- RAREZAS DE GATO ---
  const COMPANION_RARITIES = {
    "Común": { color: "Gris", id: 1 },
    "Poco Común": { color: "Naranja", id: 2 },
    "Raro": { color: "Blanco y Negro", id: 3 },
    "Épico": { color: "Marrón", id: 4 }
  };

  // --- DATOS INICIALES ---
  const INITIAL = {
    player: {
      name: "Player",
      level: 1,
      hp: 100,
      maxHp: 100, 
      xp: 0,
      xptnl: 100,
      credits: 0,
      diary: ["¡Tu aventura comienza!"],
      totalMissionsDone: 0,
      totalHabitsFailed: 0, 
      lastRandomEvent: null,
      lastCasinoVisit: null, 
      attributePoints: 0,
      attributes: { fue: 10, int: 10, des: 10, car: 10 },
      skills: { f1: false, i1: false, d1: false, c1: false },
      equipment: { amulet: null, tool: null, book: null },
      inventory: [],
      activeObstacle: null,
      // --- COMPAÑERO ---
      companion: {
        name: "Michi",
        rarity: "Común",
        color: "Gris",
        energy: 100,
        maxEnergy: 100,
        onExpedition: false,
        expeditionEnds: null,
        mimosToday: 0, 
        lastMimoReset: new Date().toDateString() 
      },// --- DATOS DE LOGIN ---
lastLoginDate: null,
loginStreak: 0
    },
    // --- LISTA COMPLETA DE 40 MISIONES ---
    missions: [
      // Guerrero (10) - Proyecto 1
      { id:1, title:"(Guerrero) 10 Flexiones", difficulty: "Facil", status:"Pendiente", reward: DIFFICULTY_REWARDS["Facil"], cooldownHours: 8, completedAt: null, projectLink: 1, projectPoints: 10 },
      { id:2, title:"(Guerrero) 20 Sentadillas", difficulty: "Facil", status:"Pendiente", reward: DIFFICULTY_REWARDS["Facil"], cooldownHours: 8, completedAt: null, projectLink: 1, projectPoints: 10 },
      { id:3, title:"(Guerrero) 30 min Caminata Rápida", difficulty: "Media", status:"Pendiente", reward: DIFFICULTY_REWARDS["Media"], cooldownHours: 12, completedAt: null, projectLink: 1, projectPoints: 20 },
      { id:4, title:"(Guerrero) 30 Abdominales", difficulty: "Facil", status:"Pendiente", reward: DIFFICULTY_REWARDS["Facil"], cooldownHours: 8, completedAt: null, projectLink: 1, projectPoints: 10 },
      { id:5, title:"(Guerrero) 30 min Estiramiento/Yoga", difficulty: "Media", status:"Pendiente", reward: DIFFICULTY_REWARDS["Media"], cooldownHours: 12, completedAt: null, projectLink: 1, projectPoints: 15 },
      { id:6, title:"(Guerrero) Subir 10 pisos por escalera", difficulty: "Dificil", status:"Pendiente", reward: DIFFICULTY_REWARDS["Dificil"], cooldownHours: 24, completedAt: null, projectLink: 1, projectPoints: 30 },
      { id:7, title:"(Guerrero) 1 hora de Ciclismo/Trote", difficulty: "Dificil", status:"Pendiente", reward: DIFFICULTY_REWARDS["Dificil"], cooldownHours: 24, completedAt: null, projectLink: 1, projectPoints: 40 },
      { id:8, title:"(Guerrero) Rutina de Fuerza (Gym/Casa) 45 min", difficulty: "Dificil", status:"Pendiente", reward: DIFFICULTY_REWARDS["Dificil"], cooldownHours: 24, completedAt: null, projectLink: 1, projectPoints: 40 },
      { id:9, title:"(Guerrero) 10 min Salto de Cuerda (Comba)", difficulty: "Media", status:"Pendiente", reward: DIFFICULTY_REWARDS["Media"], cooldownHours: 12, completedAt: null, projectLink: 1, projectPoints: 20 },
      { id:10, title:"(Guerrero) 5km Carrera (Running)", difficulty: "Epica", status:"Pendiente", reward: DIFFICULTY_REWARDS["Epica"], cooldownHours: 168, completedAt: null, projectLink: 1, projectPoints: 100 },
      
      // Sabio (10) - Proyecto 2 (11-15)
      { id:11, title:"(Sabio) 15 min App de Idioma (Duolingo, etc.)", difficulty: "Facil", status:"Pendiente", reward: DIFFICULTY_REWARDS["Facil"], cooldownHours: 8, completedAt: null, projectLink: 2, projectPoints: 10 },
      { id:12, title:"(Sabio) 30 min lección de idioma (Curso/Video)", difficulty: "Media", status:"Pendiente", reward: DIFFICULTY_REWARDS["Media"], cooldownHours: 12, completedAt: null, projectLink: 2, projectPoints: 20 },
      { id:13, title:"(Sabio) Ver 1 episodio de serie en idioma original", difficulty: "Media", status:"Pendiente", reward: DIFFICULTY_REWARDS["Media"], cooldownHours: 12, completedAt: null, projectLink: 2, projectPoints: 15 },
      { id:14, title:"(Sabio) Escribir un párrafo en nuevo idioma", difficulty: "Facil", status:"Pendiente", reward: DIFFICULTY_REWARDS["Facil"], cooldownHours: 8, completedAt: null, projectLink: 2, projectPoints: 15 },
      { id:15, title:"(Sabio) Conversar 10 min con un nativo/compañero", difficulty: "Dificil", status:"Pendiente", reward: DIFFICULTY_REWARDS["Dificil"], cooldownHours: 24, completedAt: null, projectLink: 2, projectPoints: 40 },
      { id:16, title:"(Sabio) Leer 1 capítulo de un libro", difficulty: "Facil", status:"Pendiente", reward: DIFFICULTY_REWARDS["Facil"], cooldownHours: 8, completedAt: null, projectLink: null },
      { id:17, title:"(Sabio) Meditar 10 minutos", difficulty: "Facil", status:"Pendiente", reward: DIFFICULTY_REWARDS["Facil"], cooldownHours: 8, completedAt: null, projectLink: null },
      { id:18, title:"(Sabio) Estudiar un tema nuevo 30 min (no-idioma)", difficulty: "Media", status:"Pendiente", reward: DIFFICULTY_REWARDS["Media"], cooldownHours: 12, completedAt: null, projectLink: null },
      { id:19, title:"(Sabio) Completar un módulo de curso online", difficulty: "Dificil", status:"Pendiente", reward: DIFFICULTY_REWARDS["Dificil"], cooldownHours: 24, completedAt: null, projectLink: null },
      { id:20, title:"(Sabio) Escribir en un diario personal (reflexión)", difficulty: "Facil", status:"Pendiente", reward: DIFFICULTY_REWARDS["Facil"], cooldownHours: 8, completedAt: null, projectLink: null },
      
      // Artesano (10)
      { id:21, title:"(Artesano) Limpiar el escritorio", difficulty: "Facil", status:"Pendiente", reward: DIFFICULTY_REWARDS["Facil"], cooldownHours: 8, completedAt: null, projectLink: null },
      { id:22, title:"(Artesano) Lavar los platos", difficulty: "Facil", status:"Pendiente", reward: DIFFICULTY_REWARDS["Facil"], cooldownHours: 8, completedAt: null, projectLink: null },
      { id:23, title:"(Artesano) Tender la cama al despertar", difficulty: "Facil", status:"Pendiente", reward: DIFFICULTY_REWARDS["Facil"], cooldownHours: 8, completedAt: null, projectLink: null },
      { id:24, title:"(Artesano) Organizar una habitación", difficulty: "Media", status:"Pendiente", reward: DIFFICULTY_REWARDS["Media"], cooldownHours: 12, completedAt: null, projectLink: null },
      { id:25, title:"(Artesano) Limpieza profunda (Baño/Cocina)", difficulty: "Dificil", status:"Pendiente", reward: DIFFICULTY_REWARDS["Dificil"], cooldownHours: 24, completedAt: null, projectLink: null },
      { id:26, title:"(Artesano) Cocinar una comida completa (no snacks)", difficulty: "Media", status:"Pendiente", reward: DIFFICULTY_REWARDS["Media"], cooldownHours: 12, completedAt: null, projectLink: null },
      { id:27, title:"(Artesano) Practicar un hobby (dibujo, música) 30 min", difficulty: "Media", status:"Pendiente", reward: DIFFICULTY_REWARDS["Media"], cooldownHours: 12, completedAt: null, projectLink: null },
      { id:28, title:"(Artesano) Arreglar algo roto en casa", difficulty: "Dificil", status:"Pendiente", reward: DIFFICULTY_REWARDS["Dificil"], cooldownHours: 24, completedAt: null, projectLink: null },
      { id:29, title:"(Artesano) Planificar las comidas de la semana", difficulty: "Media", status:"Pendiente", reward: DIFFICULTY_REWARDS["Media"], cooldownHours: 168, completedAt: null, projectLink: null },
      { id:30, title:"(Artesano) Proyecto de fin de semana (Pintar, armar mueble)", difficulty: "Epica", status:"Pendiente", reward: DIFFICULTY_REWARDS["Epica"], cooldownHours: 168, completedAt: null, projectLink: null },
      
      // Social (10)
      { id:31, title:"(Social) Enviar mensaje de 'cómo estás' a un amigo", difficulty: "Facil", status:"Pendiente", reward: DIFFICULTY_REWARDS["Facil"], cooldownHours: 8, completedAt: null, projectLink: null },
      { id:32, title:"(Social) Llamar a un familiar/amigo (solo por charlar)", difficulty: "Media", status:"Pendiente", reward: DIFFICULTY_REWARDS["Media"], cooldownHours: 12, completedAt: null, projectLink: null },
      { id:33, title:"(Social) Hacer un cumplido genuino a alguien", difficulty: "Facil", status:"Pendiente", reward: DIFFICULTY_REWARDS["Facil"], cooldownHours: 8, completedAt: null, projectLink: null },
      { id:34, title:"(Social) Salir a un café / Cita / Picnic", difficulty: "Media", status:"Pendiente", reward: DIFFICULTY_REWARDS["Media"], cooldownHours: 12, completedAt: null, projectLink: null },
      { id:35, title:"(Social) Asistir a un evento social (Fiesta, reunión)", difficulty: "Dificil", status:"Pendiente", reward: DIFFICULTY_REWARDS["Dificil"], cooldownHours: 24, completedAt: null, projectLink: null },
      { id:36, title:"(Social) Conocer a alguien nuevo", difficulty: "Dificil", status:"Pendiente", reward: DIFFICULTY_REWARDS["Dificil"], cooldownHours: 24, completedAt: null, projectLink: null },
      { id:37, title:"(Social) Escuchar activamente a alguien (sin interrumpir)", difficulty: "Facil", status:"Pendiente", reward: DIFFICULTY_REWARDS["Facil"], cooldownHours: 8, completedAt: null, projectLink: null },
      { id:38, title:"(Social) Organizar una reunión o salida", difficulty: "Dificil", status:"Pendiente", reward: DIFFICULTY_REWARDS["Dificil"], cooldownHours: 24, completedAt: null, projectLink: null },
      { id:39, title:"(Social) Hacer voluntariado", difficulty: "Epica", status:"Pendiente", reward: DIFFICULTY_REWARDS["Epica"], cooldownHours: 168, completedAt: null, projectLink: null },
      { id:40, title:"(Social) Tener una conversación profunda (vulnerable)", difficulty: "Media", status:"Pendiente", reward: DIFFICULTY_REWARDS["Media"], cooldownHours: 12, completedAt: null, projectLink: null }
    ],
    // --- TIENDA CON ÍTEMS DE GATO ---
    store: [
      { id:1, item:"Poción de Salud (+50 HP)", price: 25, type: 'consumable', effect: { hp: 50 }, slot: null },
      { id:2, item:"Pergamino de XP (+100 XP)", price: 50, type: 'consumable', effect: { xp: 100 }, slot: null },
      { id:3, item:"Amuleto de Salud (+10 Max HP)", price: 200, type: 'permanent', effect: { maxHp: 10 }, slot: 'amulet' },
      { id:4, item:"Pluma del Sabio (+5% XP)", price: 300, type: 'permanent', effect: { xp_bonus: 0.05 }, slot: 'tool' },
      { id:5, item:"Catnip Premium (Mejorar Gato)", price: 700, type: 'consumable', effect: { upgrade_companion: 1 }, slot: null },
      { id:6, item:"Comida de Gato (+50 Energía)", price: 15, type: 'consumable', effect: { companion_energy: 50 }, slot: null }
    ],
    projects: [
      { id: 1, title: "Proyecto: Ponerse en Forma (Largo Plazo)", description: "Se completa haciendo misiones de (Guerrero).", currentPoints: 0, totalPoints: 1000, reward: { xp: 5000, credits: 300, attributePoints: 1 } },
      { id: 2, title: "Proyecto: Aprender un Idioma (Nivel Básico)", description: "Se completa haciendo misiones de (Sabio) de estudio.", currentPoints: 0, totalPoints: 500, reward: { xp: 2500, credits: 150, attributePoints: 1 } }
    ],
    habits: [
      { id: 1, title: "Beber Vaso de Agua", desc: "+1 HP por vaso", countToday: 0, reward: { hp: 1, xp: 0 }, penalty: { hp: 0 } },
      { id: 2, title: "Pausa Activa", desc: "Estirarse 1 min (+1 HP, +1 XP)", countToday: 0, reward: { hp: 1, xp: 1 }, penalty: { hp: 0 } },
      { id: 3, title: "Comida", desc: "+5 HP (Saludable) / -5 HP (Chatarra)", countToday: 0, reward: { hp: 5 }, penalty: { hp: -5 } }
    ],
    system: {
      lastHabitReset: new Date().toDateString(),
      adminMode: true 
    },
    // --- LISTA COMPLETA DE 15 LOGROS ---
    achievements: [
      // 10 Visibles
      { id: 1, title: "Primeros Pasos", description: "Completa tu primera misión.", unlocked: false, hidden: false },
      { id: 2, title: "Aprendiz", description: "Llega al Nivel 2.", unlocked: false, hidden: false },
      { id: 3, title: "Aspirante a Guerrero", description: "Completa tu primera misión de (Guerrero).", unlocked: false, hidden: false },
      { id: 4, title: "Aspirante a Sabio", description: "Completa tu primera misión de (Sabio).", unlocked: false, hidden: false },
      { id: 5, title: "Manos a la Obra", description: "Completa tu primera misión de (Artesano).", unlocked: false, hidden: false },
      { id: 6, title: "Mariposa Social", description: "Completa tu primera misión de (Social).", unlocked: false, hidden: false },
      { id: 7, title: "Comprador", description: "Compra tu primer ítem en la Tienda.", unlocked: false, hidden: false },
      { id: 8, title: "Equipado", description: "Equipa tu primer ítem en un slot.", unlocked: false, hidden: false },
      { id: 9, title: "Habilidoso", description: "Gasta tu primer Punto de Atributo (PA).", unlocked: false, hidden: false },
      { id: 10, title: "Especialista", description: "Desbloquea tu primera Habilidad pasiva.", unlocked: false, hidden: false },
      // 5 Ocultos
      { id: 11, title: "Mata-Monstruos", description: "Derrota a tu primer Obstáculo.", unlocked: false, hidden: true },
      { id: 12, title: "Arquitecto", description: "Completa tu primer Proyecto.", unlocked: false, hidden: true },
      { id: 13, title: "Aventurero", description: "Usa el botón de Evento Aleatorio por primera vez.", unlocked: false, hidden: true },
      { id: 14, title: "Eso duele", description: "Falla un hábito (botón '-') por primera vez.", unlocked: false, hidden: true },
      { id: 15, title: "Nivel 5", description: "Alcanza el Nivel 5 del jugador.", unlocked: false, hidden: true }
    ],
    // --- ESTADO DEL CASINO ---
    casinoGame: {
      active: false,
      pot: 0,
      round: 0
    }
  };

  // --- PESTAÑAS (TABS) ---
  const TABS = ["Player", "Habilidades", "Compañero", "Minijuego", "Missions", "Proyectos", "Inventario", "Store", "Casino", "Habits", "Achievements", "Leaderboard", "Configuración"];
  const tabsEl = document.getElementById("tabs");
  const contentEl = document.getElementById("tab-content");
  
  // --- CARGA DE ESTADO (STATE) ---
  const savedState = JSON.parse(localStorage.getItem("vida_rpg_state") || "null");
  // Fusión profunda (deep merge) para asegurar que todos los campos nuevos existan
  function mergeDeep(target, source) {
    const isObject = (obj) => obj && typeof obj === 'object' && !Array.isArray(obj);
    if (!isObject(target) || !isObject(source)) return source;
    Object.keys(source).forEach(key => {
      const targetValue = target[key];
      const sourceValue = source[key];
      if (Array.isArray(targetValue) && Array.isArray(sourceValue)) {
        // Usa el array guardado si existe, si no, el inicial
        target[key] = savedState && savedState[key] ? savedState[key] : sourceValue;
      } else if (isObject(targetValue) && isObject(sourceValue)) {
        target[key] = mergeDeep(Object.assign({}, targetValue), sourceValue);
      } else {
        target[key] = sourceValue;
      }
    });
    return target;
  }
  
  let state = mergeDeep(JSON.parse(JSON.stringify(INITIAL)), savedState || {});
  state.store = INITIAL.store; // ¡Forzar actualización de la Tienda!
    state.achievements = INITIAL.achievements; // ¡Forzar actualización de Logros!

  // Asegurar que campos añadidos después existen
  if (!state.casinoGame) state.casinoGame = INITIAL.casinoGame;
  if (!state.player.companion) state.player.companion = INITIAL.player.companion;
  if (!state.player.lastCasinoVisit) state.player.lastCasinoVisit = INITIAL.player.lastCasinoVisit;
  if (state.player.companion.mimosToday === undefined) state.player.companion.mimosToday = 0; 
  if (!state.player.companion.lastMimoReset) state.player.companion.lastMimoReset = new Date().toDateString(); 
  if (state.player.loginStreak === undefined) state.player.loginStreak = 0;
  if (!state.player.lastLoginDate) state.player.lastLoginDate = null;


  // Recalcular Max HP al cargar
  state.player.maxHp = 100 + (state.player.attributes.fue * 5) + (state.player.skills.f1 ? 20 : 0);
  Object.values(state.player.equipment).forEach(item => {
    if (item && item.effect.maxHp) state.player.maxHp += item.effect.maxHp;
  });


  function saveState(){
    localStorage.setItem("vida_rpg_state", JSON.stringify(state));
  }
  
  function escapeHtml(s) {
    return String(s).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
  }
  
  function formatTime(ms) {
    if (ms <= 0) return "Listo";
    const h = Math.floor(ms / (1000 * 60 * 60));
    const m = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
    const s = Math.floor((ms % (1000 * 60)) / 1000);
    return `${h}h ${m}m ${s}s`;
  }
  
  // --- NÚCLEO: APLICAR EFECTOS ---
  function applyEffect(effect) {
    // 1. BUFFS / DEBUFFS
    let xp_bonus = 0;
    let credits_bonus = 0;
    
    // Atributo INT
    xp_bonus += (state.player.attributes.int - 10) * 0.005;
    // Atributo DES
    credits_bonus += (state.player.attributes.des - 10) * 0.005;
    
    // Habilidad de Sabio
    if (state.player.skills.i1) xp_bonus += 0.10;
    // Habilidad de Artesano
    if (state.player.skills.d1) credits_bonus += 0.10;
    
    // Equipo
    Object.values(state.player.equipment).forEach(item => {
      if (item && item.effect.xp_bonus) xp_bonus += item.effect.xp_bonus;
    });
    
    // Obstáculo
    if (state.player.activeObstacle?.debuff.type === 'xp_reduction') {
      xp_bonus -= state.player.activeObstacle.debuff.value;
    }
    
    // 2. APLICAR VALORES
    if (effect.xp) {
      state.player.xp += Math.round(effect.xp * (1 + xp_bonus));
    }
    if (effect.hp) {
      state.player.hp += effect.hp;
      if (state.player.hp > state.player.maxHp) state.player.hp = state.player.maxHp;
      if (state.player.hp < 0) state.player.hp = 0; 
    }
    if (effect.credits) {
      state.player.credits += Math.round(effect.credits * (1 + credits_bonus));
    }
    if (effect.maxHp) { // Para equipo
      state.player.maxHp += effect.maxHp;
      state.player.hp += effect.maxHp;
    }
    if (effect.attributePoints) {
      state.player.attributePoints += effect.attributePoints;
    }
    // Efectos de Compañero
    if (effect.companion_energy) {
      state.player.companion.energy += effect.companion_energy;
      if (state.player.companion.energy > state.player.companion.maxEnergy) {
        state.player.companion.energy = state.player.companion.maxEnergy;
      }
    }
  }

  function renderTabs(){
    tabsEl.innerHTML = "";
    TABS.forEach(tab => {
      const btn = document.createElement("button");
      btn.className = "tab" + (tab === "Player" ? " active" : "");
      btn.textContent = tab;
      btn.onclick = () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        btn.classList.add("active");
        renderTab(tab);
      };
      tabsEl.appendChild(btn);
    });
  }

  // --- RENDER: Pestaña Player (con Mimar) ---
  function renderPlayerTab(){
    // Evento Aleatorio
    const EVENT_COOLDOWN_MS = 24 * 60 * 60 * 1000;
    const now = Date.now();
    const lastEvent = state.player.lastRandomEvent || 0;
    const eventTimeSinceLast = now - lastEvent;
    const eventCooldownLeft = EVENT_COOLDOWN_MS - eventTimeSinceLast;
    const isEventReady = eventTimeSinceLast >= EVENT_COOLDOWN_MS;

    let eventButtonHtml = '';
    if (isEventReady) {
      eventButtonHtml = `<button class="button" id="btn-random-event">Evento Aleatorio (Listo)</button>`;
    } else {
      eventButtonHtml = `<button class="button" id="btn-random-event" disabled>Evento Aleatorio (Faltan ${formatTime(eventCooldownLeft)})</button>`;
    }
    
    // Mimos
    checkMimoReset(); // Resetear si es nuevo día
    const mimosLeft = 5 - state.player.companion.mimosToday;
    const canMimar = mimosLeft > 0;
    
    contentEl.innerHTML = `
      <h2>Ficha del jugador</h2>
      <div style="display:grid;grid-template-columns: 1fr 1fr;gap:12px;margin-top:14px">
        <div>
          <label>Nombre</label>
          <input type="text" id="f-name" style="width:100%" value="${escapeHtml(state.player.name)}">
        </div>
        <div>
          <label>Nivel</label>
          <div class="stat-value">${state.player.level}</div>
        </div>
        <div>
          <label>HP Actual / Máximo</label>
          <div class="stat-value">${state.player.hp} / ${state.player.maxHp}</div>
        </div>
        <div>
          <label>XP Actual / Siguiente Nivel</label>
          <div class="stat-value">${state.player.xp} / ${state.player.xptnl}</div>
        </div>
        <div>
          <label>Créditos</label>
          <div class="stat-value">${state.player.credits}</div>
        </div>
        <div>
          <label>Puntos de Atributo</label>
          <div class="stat-value" style="color:var(--accent2)">${state.player.attributePoints}</div>
        </div>
      </div>
      
      <div class="equipment-slots">
        <h4>Equipamiento</h4>
        <div class="equipment-slot">
          <span class="name">Amuleto:</span>
          <span class="item" id="slot-amulet">${state.player.equipment.amulet?.item || 'Vacío'}</span>
        </div>
        <div class="equipment-slot">
          <span class="name">Herramienta:</span>
          <span class="item" id="slot-tool">${state.player.equipment.tool?.item || 'Vacío'}</span>
        </div>
        <div class="equipment-slot">
          <span class="name">Libro:</span>
          <span class="item" id="slot-book">${state.player.equipment.book?.item || 'Vacío'}</span>
        </div>
      </div>
      
      <div class="mimar-section">
        <span class="companion-icon">🐱</span>
        <div>
          <label>Tu Compañero: ${state.player.companion.name} (${state.player.companion.color})</label>
          <button class="button" id="btn-mimar" ${canMimar ? '' : 'disabled'}>Mimar (+1 XP)</button>
          <span style="color:var(--muted); font-size: 13px;">(${mimosLeft} restantes hoy)</span>
        </div>
      </div>
      
      <hr style="border:1px solid var(--card); margin: 20px 0;">
      <button class="button" id="btn-save-player">Guardar Nombre</button>
      <div>
        <label>Evento Aleatorio (Cada 24h)</label>
        ${eventButtonHtml}
      </div>
    `;
    
    document.getElementById("btn-save-player").onclick = () => {
      state.player.name = document.getElementById("f-name").value;
      saveState();
      renderAll(); 
      renderTab("Player");
    };
    
    if (document.getElementById("btn-random-event") && isEventReady) {
      document.getElementById("btn-random-event").onclick = () => {
        triggerRandomEvent();
      };
    }
    
    if (document.getElementById("btn-mimar") && canMimar) {
      document.getElementById("btn-mimar").onclick = () => {
        mimarGato();
      };
    }
  }
  
  // --- LÓGICA MIMAR GATO ---
  function checkMimoReset() {
    const today = new Date().toDateString();
    if (state.player.companion.lastMimoReset !== today) {
      state.player.companion.mimosToday = 0;
      state.player.companion.lastMimoReset = today;
      // No guardar aquí, se guardará al mimar o en otro lado
    }
  }

  function mimarGato() {
    checkMimoReset(); // Asegura que el contador esté al día
    if (state.player.companion.mimosToday >= 5) return; // Límite alcanzado
    
    state.player.companion.mimosToday++;
    applyEffect({ xp: 1 }); // +1 XP
    state.player.diary.push(`¡Le das mimos a ${state.player.companion.name}! (+1 XP)`);
    
    saveState();
    renderAll();
    renderTab("Player"); // Refrescar el botón
  }
  
  // --- RENDER: Pestaña Habilidades ---
  function renderHabilidadesTab() {
    let pa = state.player.attributePoints;
    let attr = state.player.attributes;
    
    let html = `<h2>🧠 Habilidades y Atributos</h2>
      <p style="color:var(--muted); margin-top: 4px;">Puntos de Atributo (PA) disponibles: <b style="color:var(--accent2); font-size: 20px;">${pa}</b></p>
      
      <div class="skills-container">
        <div class="attribute-tree">
          <div class="attribute-header">
            <h3 class="fue">Fuerza (FUE)</h3>
            <div class="attribute-points-spend">
              <span>${attr.fue}</span>
              <button class="habit-btn" onclick="spendAttributePoint('fue')" ${pa > 0 ? '' : 'disabled'}>+</button>
            </div>
          </div>
          <p style="font-size: 13px; color: var(--muted); margin-top: 5px;">+5 HP Máx por punto.</p>
          <div class="skill-list">
            ${renderSkill(SKILL_TREE.fue[0], attr.fue, 'f1')}
          </div>
        </div>
        
        <div class="attribute-tree">
          <div class="attribute-header">
            <h3 class="int">Inteligencia (INT)</h3>
            <div class="attribute-points-spend">
              <span>${attr.int}</span>
              <button class="habit-btn" onclick="spendAttributePoint('int')" ${pa > 0 ? '' : 'disabled'}>+</button>
            </div>
          </div>
          <p style="font-size: 13px; color: var(--muted); margin-top: 5px;">+0.5% XP por punto.</p>
          <div class="skill-list">
            ${renderSkill(SKILL_TREE.int[0], attr.int, 'i1')}
          </div>
        </div>
        
        <div class="attribute-tree">
          <div class="attribute-header">
            <h3 class="des">Destreza (DES)</h3>
            <div class="attribute-points-spend">
              <span>${attr.des}</span>
              <button class="habit-btn" onclick="spendAttributePoint('des')" ${pa > 0 ? '' : 'disabled'}>+</button>
            </div>
          </div>
          <p style="font-size: 13px; color: var(--muted); margin-top: 5px;">+0.5% Créditos por punto.</p>
          <div class="skill-list">
            ${renderSkill(SKILL_TREE.des[0], attr.des, 'd1')}
          </div>
        </div>
        
        <div class="attribute-tree">
          <div class="attribute-header">
            <h3 class="car">Carisma (CAR)</h3>
            <div class="attribute-points-spend">
              <span>${attr.car}</span>
              <button class="habit-btn" onclick="spendAttributePoint('car')" ${pa > 0 ? '' : 'disabled'}>+</button>
            </div>
          </div>
          <p style="font-size: 13px; color: var(--muted); margin-top: 5px;">-0.5% Precios en Tienda por punto.</p>
          <div class="skill-list">
            ${renderSkill(SKILL_TREE.car[0], attr.car, 'c1')}
          </div>
        </div>
      </div>
    `;
    contentEl.innerHTML = html;
  }
  
  // Función auxiliar para dibujar una habilidad
  function renderSkill(skill, attrLevel, skillKey) {
    let className = "skill";
    let action = "";
    if (state.player.skills[skillKey]) {
      className += " unlocked"; // Ya la tiene
    } else if (attrLevel >= skill.req) {
      className += " can-buy"; // Puede comprarla
      action = `onclick="buySkill('${skillKey}', ${skill.req})"`;
    }
    
    return `
      <div class="${className}" ${action}>
        <h4>${skill.title}</h4>
        <p>${skill.desc}</p>
        <p style="color:var(--muted); font-size: 12px;">Requiere: ${skill.req} ${skillKey === 'i1' ? 'INT' : (skillKey === 'f1' ? 'FUE' : (skillKey === 'd1' ? 'DES' : 'CAR'))}</p>
      </div>
    `;
  }
  
  // Función para gastar puntos de atributo
  function spendAttributePoint(attr) {
    if (state.player.attributePoints <= 0) return;
    state.player.attributePoints--;
    state.player.attributes[attr]++;
    
    // Recalcular HP Máx si se sube FUE
    if (attr === 'fue') {
      recalculateMaxHp(); 
    }
    
    checkAchievements(null, 'spend_pa'); 
    
    saveState();
    renderAll(); 
    renderTab("Habilidades"); 
  }

  // Función para comprar una habilidad
  function buySkill(skillKey, req) {
    const attrKey = skillKey.substring(0,1) === 'i' ? 'int' : (skillKey.substring(0,1) === 'f' ? 'fue' : (skillKey.substring(0,1) === 'd' ? 'des' : 'car'));
    if (state.player.skills[skillKey] || state.player.attributes[attrKey] < req) return;
    
    state.player.skills[skillKey] = true;
    
    // Si es una habilidad de HP, recalcular
    if (skillKey === 'f1') {
      recalculateMaxHp(); 
    }
    
    state.player.diary.push(`¡Habilidad desbloqueada: ${SKILL_TREE[attrKey][0].title}!`);
    
    checkAchievements(null, 'buy_skill'); 
    
    saveState();
    renderAll(); 
    renderTab("Habilidades"); 
  }
  
  // Función para recalcular HP Máximo
  function recalculateMaxHp() {
    let newMax = 100; // Base
    newMax += (state.player.attributes.fue * 5); // Por Fuerza
    if (state.player.skills.f1) newMax += 20; // Habilidad
    
    // Bonus de equipo
    Object.values(state.player.equipment).forEach(item => {
      if (item && item.effect.maxHp) newMax += item.effect.maxHp;
    });
    
    let diff = newMax - state.player.maxHp;
    state.player.maxHp = newMax;
    if (diff > 0) state.player.hp += diff; // Curar al ganar HP Máx
    if (state.player.hp > state.player.maxHp) state.player.hp = state.player.maxHp;
  }
  
  // --- RENDER: Pestaña Compañero ---
  function renderCompañeroTab() {
    const comp = state.player.companion;
    const energyPct = (comp.energy / comp.maxEnergy) * 100;
    
    let html = `<h2>🐱 Compañero</h2>
      <div class="companion-header">
        <div class="companion-icon">🐱</div>
        <div>
          <div class="companion-name">${escapeHtml(comp.name)}</div>
          <div class="rarity-${comp.rarity.replace(' ', '-')}">${comp.color} (${comp.rarity})</div>
        </div>
      </div>
      
      <div class="stat">
        <label>Energía</label>
        <div class="value">${comp.energy} / ${comp.maxEnergy}</div>
        <div class="energy-bar"><div class="energy-bar-inner" style="width: ${energyPct}%"></div></div>
      </div>
    `;
    
    if (comp.onExpedition) {
      const timeLeft = comp.expeditionEnds - Date.now();
      html += `
        <div style="margin-top: 20px;">
          <p>¡${comp.name} está en una expedición!</p>
          <p style="color:var(--muted); font-size: 14px;">Volverá en: ${formatTime(timeLeft)}</p>
        </div>
      `;
    } else {
      html += `
        <div style="margin-top: 20px;">
          <p>¡${comp.name} está listo para una aventura!</p>
          <button class="button" onclick="sendCompanion()" ${comp.energy >= 50 ? '' : 'disabled'}>
            Enviar a Expedición (4h)
          </button>
          ${comp.energy < 50 ? '<p style="color:var(--stat-fue); font-size: 12px;">Requiere 50 de Energía.</p>' : ''}
        </div>
      `;
    }
    
    html += `<hr style="border:1px solid var(--card); margin: 20px 0;">
             <p style="color:var(--muted); font-size: 14px;">Puedes comprar "Comida de Gato" y "Catnip Premium" en la Tienda.</p>`;
    
    contentEl.innerHTML = html;
  }
  
  // --- LÓGICA COMPAÑERO ---
  function sendCompanion() {
    const comp = state.player.companion;
    if (comp.onExpedition || comp.energy < 50) return;
    
    comp.energy -= 50;
    comp.onExpedition = true;
    comp.expeditionEnds = Date.now() + 4 * 60 * 60 * 1000; // 4 horas
    
    state.player.diary.push(`¡${comp.name} ha salido de expedición!`);
    saveState();
    renderAll();
    renderTab("Compañero");
  }
  
  function checkCompanion() {
    const comp = state.player.companion;
    if (!comp.onExpedition || comp.expeditionEnds > Date.now()) return;
    
    // ¡Ha vuelto!
    comp.onExpedition = false;
    comp.expeditionEnds = null;
    
    // Calcular Botín
    let loot = { credits: 0, items: [] };
    const rarityId = COMPANION_RARITIES[comp.rarity].id;
    
    loot.credits = 15 + Math.floor(Math.random() * 25 * rarityId); // 15-40 (Gris), 15-115 (Marrón)

    
    if (Math.random() < 0.1 * rarityId) { // 10% (Gris), 40% (Marrón)
      loot.items.push("Poción de Salud");
      state.player.inventory.push(JSON.parse(JSON.stringify(state.store.find(i => i.id === 1))));
    }
    if (rarityId >= 4 && Math.random() < 0.1) { // 10% solo si es Épico
      loot.items.push("Pergamino de XP");
      state.player.inventory.push(JSON.parse(JSON.stringify(state.store.find(i => i.id === 2))));
    }
    
    let lootMsg = `¡${comp.name} ha vuelto! Encontró ${loot.credits} Créditos`;
    if (loot.items.length > 0) {
      lootMsg += ` y ${loot.items.join(', ')}!`;
    }
    
    state.player.diary.push(lootMsg);
    applyEffect({ credits: loot.credits });
    saveState();
    renderAll();
    
    // Si el jugador está viendo la pestaña, refrescarla
    const tabActual = document.querySelector(".tab.active")?.textContent;
    if (tabActual === "Compañero") renderTab("Compañero");
  }
  
  function upgradeCompanion() {
    const comp = state.player.companion;
    let msg = `Usaste Catnip Premium en ${comp.name}. `;
    let upgraded = false;
    
    if (comp.rarity === "Común" && Math.random() < 0.6) { // 50%
      comp.rarity = "Poco Común";
      comp.color = COMPANION_RARITIES["Poco Común"].color;
      upgraded = true;
    } else if (comp.rarity === "Poco Común" && Math.random() < 0.4) { // 30%
      comp.rarity = "Raro";
      comp.color = COMPANION_RARITIES["Raro"].color;
      upgraded = true;
    } else if (comp.rarity === "Raro" && Math.random() < 0.15) { // 10%
      comp.rarity = "Épico";
      comp.color = COMPANION_RARITIES["Épico"].color;
      upgraded = true;
    }
    
    if (upgraded) {
      msg += `¡Evolucionó! Ahora es un Gato ${comp.color} (${comp.rarity}).`;
    } else if (comp.rarity === "Épico") {
      msg += "¡Ya es perfecto! (No puede mejorar más).";
    } else {
      msg += "Le ha gustado mucho, pero no ha pasado nada...";
    }
    
    state.player.diary.push(msg);
    saveState();
    renderAll();
  }
  
  
  // --- RENDER: Pestaña Proyectos ---
  function renderProyectosTab() {
    let html = `<h2>🏗️ Proyectos a Largo Plazo</h2>
      <p style="color:var(--muted); margin-top: 4px;">Se completan automáticamente al hacer misiones vinculadas.</p>`;
    
    state.projects.forEach(p => {
      let pct = (p.currentPoints / p.totalPoints) * 100;
      if (pct > 100) pct = 100;
      
      html += `
        <div class="project-card">
          <h3>${p.title} ${p.currentPoints >= p.totalPoints ? '✅' : ''}</h3>
          <p>${p.description}</p>
          <div class="progress-bar">
            <div class="progress-bar-inner" style="width: ${pct}%;">${p.currentPoints} / ${p.totalPoints}</div>
          </div>
        </div>
      `;
    });
    
    contentEl.innerHTML = html;
  }
  
  // --- RENDER: Pestaña Inventario ---
  function renderInventarioTab() {
    let html = `<h2>🎒 Inventario</h2><table>
      <thead><tr><th>Ítem</th><th>Tipo</th><th>Efecto</th><th>Acción</th></tr></thead><tbody>`;
      
    if (state.player.inventory.length === 0) {
      html += `<tr><td colspan="4" style="text-align:center; color: var(--muted);">Inventario vacío. Compra ítems en la Tienda.</td></tr>`;
    }
    
    state.player.inventory.forEach((item, index) => {
      let actionButton = '';
      if (item.type === 'consumable') {
        actionButton = `<button class="button" onclick="useItem(${index})">Usar</button>`;
      }
      if (item.type === 'permanent') {
        const isEquipped = state.player.equipment[item.slot] && state.player.equipment[item.slot].id === item.id;
        if (isEquipped) {
          actionButton = 'Equipado ✅'; 
        } else {
          actionButton = `<button class="button" onclick="equipItem(${index})">Equipar</button>`;
        }
      }
      
      let effectDesc = '';
      if(item.effect.hp) effectDesc = `+${item.effect.hp} HP`;
      else if(item.effect.xp) effectDesc = `+${item.effect.xp} XP`;
      else if(item.effect.maxHp) effectDesc = `+${item.effect.maxHp} Max HP`;
      else if(item.effect.xp_bonus) effectDesc = `+${item.effect.xp_bonus * 100}% XP`;
      else if(item.effect.companion_energy) effectDesc = `+${item.effect.companion_energy} Energía Gato`;
      else if(item.effect.upgrade_companion) effectDesc = `Mejorar Gato`;
      
      html += `<tr>
        <td>${escapeHtml(item.item)}</td>
        <td>${item.type === 'consumable' ? 'Consumible' : 'Permanente'}</td>
        <td>${effectDesc}</td>
        <td>${actionButton}</td>
      </tr>`;
    });
    
    html += `</tbody></table>`;
    contentEl.innerHTML = html;
  }
  
  // Lógica de Inventario
  function useItem(inventoryIndex) {
    const item = state.player.inventory[inventoryIndex];
    if (!item || item.type !== 'consumable') return;
    
    // Casos especiales
    if (item.effect.upgrade_companion) {
      upgradeCompanion();
    } else {
      // Aplicar efecto normal
      applyEffect(item.effect);
      state.player.diary.push(`¡Usaste "${item.item}"!`);
    }
    
    // Remover del inventario
    state.player.inventory.splice(inventoryIndex, 1);
    
    checkLevelUp();
    saveState();
    renderAll();
    renderTab("Inventario");
    if(item.effect.companion_energy) renderTab("Compañero");
  }
  
  function equipItem(inventoryIndex) {
    const item = state.player.inventory[inventoryIndex];
    if (!item || item.type !== 'permanent' || !item.slot) return;
    
    if (state.player.equipment[item.slot]) {
      unequipItem(item.slot, false); 
    }
    
    state.player.equipment[item.slot] = item;
    state.player.inventory.splice(inventoryIndex, 1);
    
    if (item.effect.maxHp) {
      recalculateMaxHp(); 
    }
    
    state.player.diary.push(`¡Equipaste "${item.item}"!`);
    checkAchievements(null, 'equip'); 
    
    saveState();
    renderAll(); 
    renderTab("Inventario"); 
    renderTab("Player"); 
  }

  function unequipItem(slot, refresh = true) {
    const item = state.player.equipment[slot];
    if (!item) return; 

    state.player.inventory.push(item);
    
    if (item.effect.maxHp) {
      state.player.maxHp -= item.effect.maxHp;
      if (state.player.hp > state.player.maxHp) state.player.hp = state.player.maxHp;
    }
    
    state.player.equipment[slot] = null;
    state.player.diary.push(`¡Desequipaste "${item.item}"!`);
    
    if (refresh) {
      saveState();
      renderAll();
      renderTab("Inventario");
      renderTab("Player");
    }
  }

  // --- LÓGICA DE EVENTOS ALEATORIOS ---
  // --- LÓGICA DE EVENTOS ALEATORIOS (¡AHORA CON PRUEBAS DE STAT!) ---
function triggerRandomEvent() {
  const COOLDOWN_MS = 24 * 60 * 60 * 1000;
  const now = Date.now();
  const lastEvent = state.player.lastRandomEvent || 0;
  if (now - lastEvent < COOLDOWN_MS) return;

  state.player.lastRandomEvent = now;
  const event = RANDOM_EVENTS[Math.floor(Math.random() * RANDOM_EVENTS.length)];

  // --- CASO 1: Evento Interactivo (NUEVO) ---
  if (event.type === 'interactive') {

    // 1. Construir el mensaje de la mini-ventana
    let promptMessage = `${event.text}\n\n¿Qué haces?\n`;
    // CORRECCIÓN IMPORTANTE: Asegurarnos de que las opciones existan antes de leerlas
    if (event.options && event.options.length >= 4) {
      promptMessage += `1. ${event.options[0].text}\n`; // Opción 1
      promptMessage += `2. ${event.options[1].text}\n`; // Opción 2
      promptMessage += `3. ${event.options[2].text}\n`; // Opción 3
      promptMessage += `4. ${event.options[3].text}\n`; // Opción 4
    } else {
      // Si por error un evento no tiene 4 opciones, no se bloquea
      console.error("Evento interactivo mal configurado:", event);
      return; 
    }

    // 2. Mostrar la "mini-ventana" (prompt)
    const choice = prompt(promptMessage, "Escribe 1, 2, 3, o 4");
    const choiceIndex = parseInt(choice) - 1; // Convertir "1" en 0, "2" en 1, etc.

    // 3. Validar la elección
    if (choiceIndex < 0 || choiceIndex > 3 || isNaN(choiceIndex)) {
      alert("No te decidiste y la oportunidad pasó. ¡Más suerte la próxima!");
      state.player.diary.push(`(Evento) Dudaste y la oportunidad pasó.`);
      saveState();
      renderAll();
      renderTab("Player");
      return;
    }

    // 4. Calcular el éxito
    const chosenOption = event.options[choiceIndex];
    const statKey = chosenOption.stat; // 'fue', 'int', 'des', o 'car'
    const playerStatValue = state.player.attributes[statKey]; // p.ej. 10, 15, 20...

    // --- CÁLCULO DE PROBABILIDAD ---
    // Con 10 de stat (base) tienes un 30% de éxito.
    // Con 20 de stat tienes un 60% de éxito.
    // Con 30 de stat tienes un 90% de éxito.
    // Aseguramos un mínimo de 5% y máximo de 95%
    let successChance = (playerStatValue * 3) / 100; // p.ej. 10 * 3 = 30 -> 0.30
    if (successChance < 0.05) successChance = 0.05;
    if (successChance > 0.95) successChance = 0.95;

    const roll = Math.random(); // Un número entre 0.0 y 1.0

    if (roll < successChance) {
      // ¡ÉXITO!
      alert(`¡ÉXITO! (Stat: ${statKey.toUpperCase()} ${playerStatValue})\n\n${event.success_text}`);
      state.player.diary.push(`(Evento) ¡Éxito! ${event.success_text}`);
      applyEffect(event.success_reward);

    } else {
      // ¡FALLO!
      alert(`¡FALLO! (Stat: ${statKey.toUpperCase()} ${playerStatValue})\n\n${event.fail_text}`);
      state.player.diary.push(`(Evento) ¡Fallo! ${event.fail_text}`);
      applyEffect(event.fail_penalty);
    }

  // --- CASO 2: Evento de Obstáculo (Antiguo) ---
  } else if (event.type === 'obstacle') {
    state.player.diary.push(`(Evento) ${event.text}`);
    const obstacleData = OBSTACLES[event.obstacle];
    if (obstacleData && !state.player.activeObstacle) {
      state.player.activeObstacle = JSON.parse(JSON.stringify(obstacleData)); // Clonar
    }

  // --- CASO 3: Evento de Misión (Antiguo) ---
  } else if (event.type === 'mission') {
    state.player.diary.push(`(Evento) ${event.text}`);
    const nid = state.missions.length ? Math.max(...state.missions.map(x=>x.id)) + 1 : 1;
    const defaultDiff = "Facil";
    state.missions.push({ 
      id: nid, 
      title: event.mission.title, 
      difficulty: event.mission.difficulty, 
      status:"Pendiente", 
      reward: DIFFICULTY_REWARDS[defaultDiff], 
      cooldownHours: 0, 
      completedAt: null,
      projectLink: null
    });

  // --- CASO 4: Evento simple (Por si queda alguno) ---
  } else if (event.effect) {
    state.player.diary.push(`(Evento) ${event.text}`);
    applyEffect(event.effect);
  }

  // 5. Finalizar
  checkLevelUp();
  checkAchievements(null, 'random_event'); // Mantenemos el logro de "usar evento"
  saveState();
  renderAll();
  renderTab("Player");
}


  // --- LÓGICA DE MISIONES Y NIVEL ---
  function checkMissionCooldowns() {
    const now = Date.now();
    let oneMissionReset = false;
    state.missions.forEach(m => {
      if (m.status === "Completada" && m.completedAt && m.cooldownHours > 0) {
        const cooldownMillis = m.cooldownHours * 60 * 60 * 1000;
        if (now >= (m.completedAt + cooldownMillis)) {
          m.status = "Pendiente";
          m.completedAt = null;
          oneMissionReset = true;
        }
      }
    });
    if (oneMissionReset) {
      saveState();
    }
  }
  
  function checkHabitReset() {
    const today = new Date().toDateString();
    if (state.system.lastHabitReset !== today) {
      state.habits.forEach(h => h.countToday = 0);
      state.system.lastHabitReset = today;
      // No guardar aquí, se guarda en otro lado
    }
  }

  function renderMissionsTab(){
    checkMissionCooldowns(); 
    const isAdmin = state.system.adminMode;
    
    let html = `<h2>🗺️ Misiones</h2>
      <div class="table-wrapper">
      <table>
      <thead><tr><th>ID</th><th>Descripción</th><th>Dificultad</th><th>Estado</th><th>Recompensa</th><th>Acción</th></tr></thead><tbody>`;
    
    state.missions.forEach(m => {
      
      let difficultyCell = '';
      if (isAdmin) {
        const difficultyOptions = Object.keys(DIFFICULTY_REWARDS).map(d => 
          `<option value="${d}" ${m.difficulty === d ? 'selected' : ''}>${d}</option>`
        ).join('');
        difficultyCell = `<td>
            <select id="mission-diff-${m.id}" onchange="updateMission(${m.id})"> ${difficultyOptions}
            </select>
          </td>`;
      } else {
        difficultyCell = `<td><span class="difficulty difficulty-${m.difficulty}">${escapeHtml(m.difficulty)}</span></td>`;
      }

      const actionButton = m.status === 'Pendiente' 
        ? `<button class="button" onclick="completeMission(${m.id})">Completar</button>` 
        : (m.cooldownHours > 0 ? '✅ Enfriando' : '✅ Completada');

      html += `<tr>
        <td>${m.id}</td>
        <td><input type="text" id="mission-title-${m.id}" value="${escapeHtml(m.title)}" onchange="updateMission(${m.id})"></td> ${difficultyCell}
        <td>${m.status === 'Completada' && m.cooldownHours > 0 ? 'Enfriando...' : escapeHtml(m.status)}</td>
        <td>${m.reward.xp || 0} XP, ${m.reward.credits || 0} C</td>
        <td>
          ${actionButton}
        </td>
      </tr>`;
    });
    html += `</tbody></table></div>`;
    html += `<button class="button" id="add-mission">Agregar nueva misión</button>`;
    html += `<button class="button" id="reset-cooldowns" style="background: var(--accent2);">Restablecer Cooldowns</button>`;
    
    contentEl.innerHTML = html;
    
    document.getElementById("add-mission").onclick = () => {
      const nid = state.missions.length ? Math.max(...state.missions.map(x=>x.id)) + 1 : 1;
      const defaultDiff = "Facil";
      state.missions.push({ 
        id: nid, title:"Nueva misión - Editar", difficulty: defaultDiff, status:"Pendiente", 
        reward: DIFFICULTY_REWARDS[defaultDiff], 
        cooldownHours: DIFFICULTY_REWARDS[defaultDiff].cooldownHours, 
        completedAt: null, projectLink: null
      });
      saveState();
      renderTab("Missions");
    };

    document.getElementById("reset-cooldowns").onclick = () => {
      state.missions.forEach(m => {
        if (m.status === "Completada") {
          m.status = "Pendiente";
          m.completedAt = null;
        }
      });
      saveState();
      renderTab("Missions"); 
    };
  }

  // --- updateMission() (Ahora se llama al cambiar input/select) ---
  function updateMission(missionId) {
    const mission = state.missions.find(m => m.id === missionId);
    if (!mission) return;
    const isAdmin = state.system.adminMode;

    const newTitle = document.getElementById(`mission-title-${missionId}`).value;
    mission.title = newTitle;

    if (isAdmin) {
      const newDifficulty = document.getElementById(`mission-diff-${missionId}`).value;
      if (mission.difficulty !== newDifficulty) {
        mission.difficulty = newDifficulty;
        const newRewards = DIFFICULTY_REWARDS[newDifficulty];
        if (newRewards) {
          mission.reward.xp = newRewards.xp;
          mission.reward.credits = newRewards.credits;
          mission.cooldownHours = newRewards.cooldownHours;
        }
      }
    }
    saveState(); // Guardar inmediatamente al editar
    // No refrescar aquí para permitir seguir editando
  }

  function completeMission(missionId) {
    const mission = state.missions.find(m => m.id === missionId);
    if (!mission || mission.status !== 'Pendiente') return; 

    // Guardar cambios pendientes antes de completar
    updateMission(missionId); 

    // 1. Aplicar recompensa
    applyEffect(mission.reward);
    // --- INICIO: LÓGICA DE LOOT DROP ---
const lootChance = 0.10; // 10% de probabilidad
if (Math.random() < lootChance) {
  // ¡Loot! Vamos a dar una Poción de Salud (ID 1 de la tienda)
  const lootItem = state.store.find(i => i.id === 1);
  if (lootItem) {
    state.player.inventory.push(JSON.parse(JSON.stringify(lootItem)));
    state.player.diary.push(`¡Suerte! Encontraste un/a "${lootItem.item}" al completar la misión.`);
  }
}
// --- FIN: LÓGICA DE LOOT DROP ---

    state.player.totalMissionsDone++;

    // 2. Marcar misión
    mission.status = "Completada";
    mission.completedAt = Date.now(); 
    state.player.diary.push(`¡Misión completada: "${mission.title}"!`);

    // 3. Dañar Obstáculo (si existe)
    if (state.player.activeObstacle) {
      let damage = mission.reward.xp * 0.5; // Daño = 50% del XP base de la misión
      state.player.activeObstacle.hp -= damage;
      state.player.diary.push(`¡Atacas a "${state.player.activeObstacle.name}" por ${damage} de daño!`);
      
      if (state.player.activeObstacle.hp <= 0) {
        state.player.diary.push(`¡Has derrotado al Obstáculo: "${state.player.activeObstacle.name}"!`);
        state.player.activeObstacle = null;
        applyEffect({ xp: 100, credits: 50 }); // Recompensa por derrotarlo
        checkAchievements(null, 'obstacle_defeated'); 
      }
    }
    
    // 4. Añadir a Proyecto (si está vinculado)
    if (mission.projectLink && mission.projectPoints) {
      const project = state.projects.find(p => p.id === mission.projectLink);
      if (project && project.currentPoints < project.totalPoints) {
        project.currentPoints += mission.projectPoints;
        state.player.diary.push(`¡Tu proyecto "${project.title}" ha avanzado!`);
        
        // Comprobar si se completó el proyecto
        if (project.currentPoints >= project.totalPoints) {
          state.player.diary.push(`¡PROYECTO COMPLETADO: "${project.title}"!`);
          applyEffect(project.reward);
          checkAchievements(null, 'project_completed'); 
        }
      }
    }

    // 5. Revisar Nivel y Logros
    checkLevelUp(); 
    checkAchievements(mission); 

    saveState(); 
    renderAll(); 
    renderTab("Missions"); 
  }

  function checkLevelUp() {
    while (state.player.xp >= state.player.xptnl) {
      
      state.player.xp = state.player.xp - state.player.xptnl;
      state.player.level++;
      state.player.attributePoints += 5; 
      state.player.hp = state.player.maxHp; 
      state.player.xptnl = Math.floor(state.player.xptnl * 1.5);

      state.player.diary.push(`¡SUBISTE AL NIVEL ${state.player.level}! Ganas 5 Puntos de Atributo (PA).`);
      updateLeaderboard(state.player.name, state.player.level); // Enviar el nuevo nivel al Leaderboard
    
      
      checkAchievements(); 
    }
  }

  // --- RENDER: Pestaña Tienda ---
  function renderStoreTab(){
    let html = `<h2>🛒 Tienda</h2><table>
      <thead><tr><th>Ítem</th><th>Efecto</th><th>Precio</th><th>Acción</th></tr></thead><tbody>`;
    
    const priceModifier = 1 - (state.player.attributes.car * 0.005) - (state.player.skills.c1 ? 0.10 : 0);
    
    state.store.forEach(s => {
      const finalPrice = Math.round(s.price * priceModifier);
      const canAfford = state.player.credits >= finalPrice;
      let actionButton = '';
      
      if (s.type === 'permanent') {
        const isOwned = state.player.inventory.find(i => i.id === s.id) || Object.values(state.player.equipment).find(i => i && i.id === s.id);
        if (isOwned) {
          actionButton = 'Comprado ✅';
        } else {
          actionButton = `<button class="button" onclick="buyItem(${s.id})" ${canAfford ? '' : 'disabled'}>Comprar</button>`;
        }
      } else { // Consumable
        actionButton = `<button class="button" onclick="buyItem(${s.id})" ${canAfford ? '' : 'disabled'}>Comprar</button>`;
      }
      
      let effectDesc = '';
      if(s.effect.hp) effectDesc = `+${s.effect.hp} HP`;
      else if(s.effect.xp) effectDesc = `+${s.effect.xp} XP`;
      else if(s.effect.maxHp) effectDesc = `+${s.effect.maxHp} Max HP`;
      else if(s.effect.xp_bonus) effectDesc = `+${s.effect.xp_bonus * 100}% XP`;
      else if(s.effect.companion_energy) effectDesc = `+${s.effect.companion_energy} Energía Gato`;
      else if(s.effect.upgrade_companion) effectDesc = `Mejorar Gato`;
      
      html += `<tr>
        <td>${escapeHtml(s.item)}</td>
        <td>${effectDesc}</td>
        <td>${finalPrice} C ${priceModifier < 1 ? '<span style="color:var(--stat-des);font-size:12px;">(-' + Math.round((1 - priceModifier) * 100) + '%)</span>' : ''}</td>
        <td>${actionButton}</td>
      </tr>`;
    });
    html += `</tbody></table>`;
    contentEl.innerHTML = html;
  }
  
  function buyItem(itemId) {
    const item = state.store.find(s => s.id === itemId);
    const priceModifier = 1 - (state.player.attributes.car * 0.005) - (state.player.skills.c1 ? 0.10 : 0);
    const finalPrice = Math.round(item.price * priceModifier);
    
    if (!item || state.player.credits < finalPrice) return; 
    
    state.player.credits -= finalPrice;
    state.player.inventory.push(JSON.parse(JSON.stringify(item))); 
    state.player.diary.push(`¡Compraste "${item.item}"!`);
    
    checkAchievements(null, 'buy_item'); 
    saveState();
    renderAll();
    renderTab("Store");
  }
  
  // --- RENDER: Pestaña Casino (Con mensajes y cooldown 1h) ---
  function renderCasinoTab() {
    const COOLDOWN_MS = 1 * 60 * 60 * 1000; // <-- 1 HORA
    const now = Date.now();
    const lastVisit = state.player.lastCasinoVisit || 0;
    const cooldownLeft = COOLDOWN_MS - (now - lastVisit);
    const isCasinoReady = cooldownLeft <= 0;
    
    let html = `<h2>🎰 Casino "Doble o Nada"</h2>`;
    
    if (state.casinoGame.active) {
      // --- VISTA: JUEGO ACTIVO ---
      html += `
        <div class="casino-game">
          <p class="round">Ronda ${state.casinoGame.round}</p>
          <label>Pozo Actual</label>
          <div class="pot">${state.casinoGame.pot} C</div>
          <p style="color:var(--muted); margin-top: 4px;">¿Qué harás?</p>
          <div class="casino-actions">
            <button class="button" onclick="playCasinoRound()" style="background: var(--stat-des);">¡Doble o Nada!</button>
            <button class="button" onclick="casinoRetirarse()">Retirarse</button>
          </div>
        </div>
      `;
    } else if (isCasinoReady) {
      // --- VISTA: LISTO PARA JUGAR ---
      const canAfford = state.player.credits >= 25;
      html += `
        <div class="casino-game">
          <p>¡Tienta a tu suerte! La entrada cuesta 25 Créditos.</p>
          <p style="color:var(--muted); margin-top: 4px;">Gana y podrás duplicar tu apuesta. Pierde y lo perderás todo.</p>
          <button class="button" onclick="startCasinoGame()" ${canAfford ? '' : 'disabled'}>
            Apostar 25 Créditos
          </button>
          ${!canAfford ? '<p style="color:var(--stat-fue); font-size: 12px;">No tienes suficientes créditos.</p>' : ''}
        </div>
      `;
    } else {
      // --- VISTA: EN COOLDOWN ---
      html += `
        <div class="casino-game">
          <p>El casino está cerrado por ahora.</p>
          <p style="color:var(--muted); margin-top: 4px;">Vuelve en: <b>${formatTime(cooldownLeft)}</b></p>
        </div>
      `;
    }
    
    contentEl.innerHTML = html;
  }
  
  // --- LÓGICA CASINO (Con mensajes y cooldown 1h) ---
  function startCasinoGame() {
    const cost = 25;
    if (state.player.credits < cost) return;
    
    state.player.credits -= cost;
    state.casinoGame = {
      active: true,
      pot: cost * 2, // Ganas la primera ronda automáticamente
      round: 1
    };
    
    state.player.diary.push(`¡Apostaste 25C en el casino! Pozo inicial: ${state.casinoGame.pot}C`);
    saveState();
    renderAll();
    renderTab("Casino");
  }
  
  function playCasinoRound() {
    if (!state.casinoGame.active) return;
    
    if (Math.random() < 0.5) {
      // --- ¡GANA! ---
      state.casinoGame.round++;
      state.casinoGame.pot *= 2;
      alert(`¡GANASTE! 🎉\n\nTu pozo ahora es de ${state.casinoGame.pot} Créditos.\n¿Seguirás jugando?`); 
      state.player.diary.push(`¡DOBLE en el Casino! El pozo sube a ${state.casinoGame.pot}C.`);
    } else {
      // --- ¡PIERDE! ---
      const lostPot = state.casinoGame.pot;
      alert(`¡PERDISTE! 😭\n\nHas perdido el pozo de ${lostPot} Créditos.\n¡Más suerte la próxima vez!`); 
      state.player.diary.push(`¡PERDISTE en el Casino! El pozo de ${lostPot}C se ha perdido.`);
      state.player.lastCasinoVisit = Date.now(); // Poner cooldown
      state.casinoGame = { active: false, pot: 0, round: 0 };
    }
    
    saveState();
    renderAll();
    renderTab("Casino");
  }
  
  function casinoRetirarse() {
    if (!state.casinoGame.active) return;
    
    const winnings = state.casinoGame.pot;
    state.player.credits += winnings;
    alert(`¡Te retiras con ${winnings} Créditos! 💰`); 
    state.player.diary.push(`¡Te retiras del casino con ${winnings}C!`);
    
    state.player.lastCasinoVisit = Date.now(); // Poner cooldown
    state.casinoGame = { active: false, pot: 0, round: 0 };
    
    saveState();
    renderAll();
    renderTab("Casino");
  }

  // --- RENDER: Pestaña Hábitos ---
  function renderHabitsTab() {
    checkHabitReset(); 
    let html = `<h2>🧘 Hábitos Diarios</h2>
      <p style="color:var(--muted); margin-top: 4px;">Pequeñas acciones que se reinician cada día.</p>
      <div class="habits-list">`;
    
    state.habits.forEach(h => {
      html += `
        <div class="habit-card">
          <div class="habit-details">
            <h3>${escapeHtml(h.title)}</h3>
            <p>${escapeHtml(h.desc)}</p>
          </div>
          <div class="habit-controls">
            <button class="habit-btn minus" onclick="doHabit(${h.id}, false)">-</button>
            <span class="habit-count">${h.countToday}</span>
            <button class="habit-btn" onclick="doHabit(${h.id}, true)">+</button>
          </div>
        </div>
      `;
    });
    html += `</div>`;
    contentEl.innerHTML = html;
  }
  
  function doHabit(habitId, isPositive) {
    const habit = state.habits.find(h => h.id === habitId);
    if (!habit) return;
    
    if (isPositive) {
      habit.countToday++;
      applyEffect(habit.reward);
      state.player.diary.push(`(Hábito+) ${habit.title}`);
    } else {
      habit.countToday--;
      applyEffect(habit.penalty);
      state.player.diary.push(`(Hábito-) ${habit.title}`);
      state.player.totalHabitsFailed++; 
      checkAchievements(null, 'fail_habit'); 
    }
    
    checkLevelUp(); 
    saveState();
    renderAll();
    renderTab("Habits");
  }
  
  // --- RENDER: Pestaña Logros ---
  function renderAchievementsTab() {
    let html = `<h2>🏆 Logros</h2><div class="achievements-list">`;
    state.achievements.forEach(a => {
      let classes = `achievement-card ${a.unlocked ? 'unlocked' : ''}`;
      let title = escapeHtml(a.title);
      let desc = escapeHtml(a.description);
      let icon = a.unlocked ? '🏆' : '🔒';
      
      if (a.hidden) {
        classes += ' hidden-ach';
        if (!a.unlocked) {
          title = 'Logro Oculto';
          desc = 'Sigue jugando para descubrirlo...';
          icon = '❓';
        }
      }
      
      html += `
        <div class="${classes}">
          <div class="achievement-icon">${icon}</div>
          <div class="achievement-details">
            <h3>${title}</h3>
            <p>${desc}</p>
          </div>
        </div>
      `;
    });
    html += `</div>`;
    contentEl.innerHTML = html;
  }
  
  function unlockAchievement(id) {
    const achievement = state.achievements.find(a => a.id === id);
    if (achievement && !achievement.unlocked) {
      achievement.unlocked = true;
      state.player.diary.push(`¡LOGRO DESBLOQUEADO: ${achievement.title}!`);
      saveState();
      // No llamar a renderAll() aquí para evitar bucles
    }
  }

  function checkAchievements(completedMission = null, eventType = null) {
    // Eventos generales
    if (state.player.totalMissionsDone >= 1) unlockAchievement(1);
    if (state.player.level >= 2) unlockAchievement(2);
    if (state.player.level >= 5) unlockAchievement(15); // Oculto
    
    // Por tipo de misión
    if (completedMission) {
      if (completedMission.title.includes("(Guerrero)")) unlockAchievement(3);
      if (completedMission.title.includes("(Sabio)")) unlockAchievement(4);
      if (completedMission.title.includes("(Artesano)")) unlockAchievement(5);
      if (completedMission.title.includes("(Social)")) unlockAchievement(6);
    }
    
    // Por evento
    if (eventType === 'buy_item') unlockAchievement(7);
    if (eventType === 'equip') unlockAchievement(8);
    if (eventType === 'spend_pa') unlockAchievement(9);
    if (eventType === 'buy_skill') unlockAchievement(10);
    if (eventType === 'obstacle_defeated') unlockAchievement(11); // Oculto
    if (eventType === 'project_completed') unlockAchievement(12); // Oculto
    if (eventType === 'random_event') unlockAchievement(13); // Oculto
    if (eventType === 'fail_habit' && state.player.totalHabitsFailed >= 1) unlockAchievement(14); // Oculto
  }
  
  // --- RENDER: Pestaña Configuración ---
  function renderConfiguracionTab() {
    let html = `<h2>⚙️ Configuración</h2>
      
      <div style="margin-top: 15px;">
        <label>Modo Administrador (Editar dificultad de misión)</label>
        <button class="button" id="btn-admin-mode" style="background: ${state.system.adminMode ? 'var(--stat-des)' : 'var(--stat-fue)'};">
          ${state.system.adminMode ? 'Activado' : 'Desactivado'}
        </button>
      </div>
      
      <div style="margin-top: 15px;">
        <label>Forzar reseteo de contadores de hábitos y mimos</label>
        <button class="button" id="btn-reset-habits" style="background: var(--accent2);">Resetear Contadores</button>
      </div>
      
      <hr style="border:1px solid var(--card); margin: 20px 0;">
      
      <div style="margin-top: 15px;">
        <label style="color: var(--stat-fue); font-weight: bold;">Zona de Peligro</label>
        <button class="button" id="btn-wipe-save" style="background: var(--stat-fue);">BORRAR PARTIDA</button>
      </div>
    `;
    contentEl.innerHTML = html;
    
    // Listeners
    document.getElementById('btn-admin-mode').onclick = () => {
      state.system.adminMode = !state.system.adminMode;
      saveState();
      renderTab("Configuración");
    };
    
    document.getElementById('btn-reset-habits').onclick = () => {
      state.habits.forEach(h => h.countToday = 0);
      state.system.lastHabitReset = new Date().toDateString();
      state.player.companion.mimosToday = 0; 
      state.player.companion.lastMimoReset = new Date().toDateString();
      saveState();
      renderTab("Configuración");
      renderTab("Player"); // Refrescar mimos en Player
    };
    
    document.getElementById('btn-wipe-save').onclick = () => {
      if (confirm("¿ESTÁS SEGURO?\n\nEsto borrará todo tu progreso permanentemente. No se puede deshacer.")) {
        localStorage.clear();
        location.reload();
      }
    };
  }

  // --- RENDER: Función de Pestaña Principal ---
  function renderTab(tab) {
    if (tab === "Player") renderPlayerTab();
    else if (tab === "Habilidades") renderHabilidadesTab();
    else if (tab === "Compañero") renderCompañeroTab();
    else if (tab === "Minijuego") renderMinijuegoTab();
    else if (tab === "Missions") renderMissionsTab();
    else if (tab === "Proyectos") renderProyectosTab();
    else if (tab === "Inventario") renderInventarioTab();
    else if (tab === "Store") renderStoreTab();
    else if (tab === "Casino") renderCasinoTab();
    else if (tab === "Habits") renderHabitsTab();
    else if (tab === "Configuración") renderConfiguracionTab();
    else if (tab === "Achievements") renderAchievementsTab();
    else if (tab === "Leaderboard") renderLeaderboardTab();
  }

  // --- RENDER: Obstáculo ---
  function renderObstacleWidget() {
    const widget = document.getElementById("obstacle-widget");
    const obs = state.player.activeObstacle;
    if (obs) {
      widget.style.display = 'block';
      widget.innerHTML = `
        <h3>¡Obstáculo Activo!</h3>
        <h4 style="color: var(--stat-fue);">${obs.name}</h4>
        <p style="font-size: 14px; color: var(--muted);">${obs.description}</p>
        <p><b>Salud: ${obs.hp} / ${OBSTACLES[obs.name].hp}</b></p>
      `;
    } else {
      widget.style.display = 'none';
      widget.innerHTML = '';
    }
  }

  // --- RENDER: Función de Renderizado General ---
  function renderAll() {
    // 1. Recalcular Stats Base
    recalculateMaxHp(); 
    
    // 2. Panel Lateral
    document.getElementById("player-name").textContent = state.player.name;
    document.getElementById("player-level").textContent = state.player.level;
    document.getElementById("player-credits").textContent = state.player.credits;
    document.getElementById("player-pa").textContent = state.player.attributePoints;
    
    const currentHp = state.player.hp || 0;
    const maxHp = state.player.maxHp || 100;
    const currentXp = state.player.xp || 0;
    const nextXp = state.player.xptnl || 100;

    document.getElementById("player-hp").textContent = `${currentHp} / ${maxHp}`;
    document.getElementById("player-xp").textContent = `${currentXp} / ${nextXp}`;
    
    // 3. Diario
    let diaryEl = document.getElementById("diary");
    // CORRECCIÓN BUG: Asegurar que diary es un array
    diaryEl.innerHTML = (Array.isArray(state.player.diary) ? state.player.diary : []).map(e => `<div>${escapeHtml(String(e))}</div>`).join("");
    diaryEl.scrollTop = diaryEl.scrollHeight;
    
    // 4. Widget de Obstáculo
    renderObstacleWidget();
  }
// --- LÓGICA MINI-JUEGO ---
let minigame = {
  active: false,
  clicksLeft: 0,
  toyTimeout: null,
  nextToyTimeout: null
};

function renderMinijuegoTab() {
  const comp = state.player.companion;
  const canPlay = comp.energy >= 10;

  contentEl.innerHTML = `
    <h2>🐭 Jugar con Michi</h2>
    <div id="minigame-container">
      <p style="color:var(--muted); margin-top: 4px;">¡Gasta 10 de Energía ⚡ para jugar con ${comp.name} y ganar recompensas!</p>

      <button class="button" id="btn-start-minigame" ${canPlay ? '' : 'disabled'}>
        ${canPlay ? 'Jugar (Cuesta 10 ⚡)' : 'Michi está cansado'}
      </button>

      <div id="minigame-status">¡Haz clic en el juguete 10 veces!</div>

      <div id="minigame-area">
        <div id="minigame-toy">🐭</div>
      </div>
    </div>
  `;

  document.getElementById("btn-start-minigame").onclick = startMinigame;

  // Si el juego está activo, no mostrar el botón de start
  if (minigame.active) {
    document.getElementById("btn-start-minigame").style.display = 'none';
    document.getElementById("minigame-status").textContent = `¡Atrapa el juguete! Quedan ${minigame.clicksLeft} clics.`;
  } else {
    document.getElementById("minigame-status").style.display = 'none';
  }
}

function startMinigame() {
  if (state.player.companion.energy < 10 || minigame.active) return;

  // Costo y estado
  state.player.companion.energy -= 10;
  minigame.active = true;
  minigame.clicksLeft = 10;

  // Actualizar UI
  document.getElementById("btn-start-minigame").style.display = 'none';
  const statusEl = document.getElementById("minigame-status");
  statusEl.style.display = 'block';
  statusEl.textContent = `¡Atrapa el juguete! Quedan ${minigame.clicksLeft} clics.`;

  state.player.diary.push(`¡Empezaste a jugar con ${state.player.companion.name}!`);
  saveState();
  renderAll(); // Para actualizar la energía en el panel lateral si está visible

  showMinigameToy();
}

function showMinigameToy() {
  if (!minigame.active) return;

  const area = document.getElementById("minigame-area");
  const toy = document.getElementById("minigame-toy");

  const areaRect = area.getBoundingClientRect();
  const top = Math.random() * (areaRect.height - 50); // 50 es el alto del juguete
  const left = Math.random() * (areaRect.width - 50);  // 50 es el ancho

  toy.style.top = `${top}px`;
  toy.style.left = `${left}px`;
  toy.style.display = 'block';

  toy.onclick = () => onToyClick();

  // El juguete desaparece después de un tiempo
  minigame.toyTimeout = setTimeout(() => {
    hideMinigameToy();
    minigame.nextToyTimeout = setTimeout(showMinigameToy, 300); // Siguiente juguete
  }, 1200); // 1.2 segundos para hacer clic
}

function hideMinigameToy() {
  document.getElementById("minigame-toy").style.display = 'none';
  clearTimeout(minigame.toyTimeout);
  clearTimeout(minigame.nextToyTimeout);
}

function onToyClick() {
  if (!minigame.active) return;

  minigame.clicksLeft--;
  document.getElementById("minigame-status").textContent = `¡Atrapa el juguete! Quedan ${minigame.clicksLeft} clics.`;

  hideMinigameToy();

  if (minigame.clicksLeft <= 0) {
    endMinigame();
  } else {
    // Siguiente juguete aparece rápido
    minigame.nextToyTimeout = setTimeout(showMinigameToy, 250); // 0.25 segundos
  }
}

function endMinigame() {
  minigame.active = false;

  applyEffect({ credits: 15, xp: 5 });
  state.player.diary.push(`¡Juego terminado! Ganaste 15 Créditos y 5 XP.`);

  // Actualizar UI
  document.getElementById("minigame-status").textContent = '¡Ganaste! (+15 C, +5 XP)';
  const startBtn = document.getElementById("btn-start-minigame");
  startBtn.style.display = 'block';

  // Revisar si puede volver a jugar
  if (state.player.companion.energy < 10) {
    startBtn.disabled = true;
    startBtn.textContent = 'Michi está cansado';
  } else {
    startBtn.disabled = false;
    startBtn.textContent = 'Jugar de nuevo (Cuesta 10 ⚡)';
  }

  checkLevelUp();
  saveState();
  renderAll();
}
// --- LÓGICA DE RECOMPENSA DIARIA (LOGIN STREAK) ---
function checkDailyLogin() {
  const today = new Date().toDateString();

  // 1. Ya se conectó hoy. No hacer nada.
  if (state.player.lastLoginDate === today) {
    return; 
  }

  const yesterday = new Date(Date.now() - 86400000).toDateString(); // 86400000ms = 24h
  let baseReward = 20;

  // 2. Es una racha (se conectó ayer)
  if (state.player.lastLoginDate === yesterday) {
    state.player.loginStreak++;
  } 
  // 3. Rompió la racha (no se conectó ni hoy ni ayer)
  else {
    state.player.loginStreak = 1;
  }

  // Actualizar la fecha de login
  state.player.lastLoginDate = today;

  // Calcular y dar recompensa
  let finalReward = baseReward * state.player.loginStreak;
  applyEffect({ credits: finalReward });

  let rewardMsg = `¡Racha de conexión: Día ${state.player.loginStreak}! Ganas ${finalReward} Créditos.`;
  if (state.player.loginStreak === 1) {
     rewardMsg = `¡Bienvenido! Ganas ${finalReward} Créditos por tu conexión diaria.`;
  }

  state.player.diary.push(rewardMsg);
  saveState();
  // No necesitamos renderAll() aquí, porque se llamará después.
}
// --- LÓGICA DE LEADERBOARD (NUEVO) ---

// Función para ENVIAR datos a Firebase
function updateLeaderboard(playerName, playerLevel) {
  if (!db) return; // No hacer nada si Firebase no se conectó

  // Usamos el nombre del jugador como ID único.
  // .set() crea el documento si no existe, o lo sobrescribe si ya existe.
  db.collection("leaderboard").doc(playerName).set({
    name: playerName,
    level: playerLevel
  })
  .then(() => {
    console.log("¡Puntuación actualizada en el Leaderboard!");
  })
  .catch((error) => {
    console.error("Error al escribir en el Leaderboard: ", error);
    // Opcional: registrar el error en el diario
    // state.player.diary.push(`(Error de conexión con el Leaderboard)`);
  });
}

// Función para LEER y RENDERIZAR la pestaña del Leaderboard
function renderLeaderboardTab() {
  if (!db) {
     contentEl.innerHTML = `<h2>🏆 Leaderboard</h2><p style="color:var(--stat-fue);">Error: No se pudo conectar a la base de datos de Firebase.</p>`;
     return;
  }

  let html = `<h2>🏆 Leaderboard (Top 10)</h2>
    <p style="color:var(--muted); margin-top: 4px;">¡Compite con tus amigos!</p>
    <button class="button" id="btn-refresh-leaderboard">Actualizar</button>
    <div class="table-wrapper" style="margin-top: 15px;">
      <table>
        <thead><tr><th>Pos.</th><th>Nombre</th><th>Nivel</th></tr></thead>
        <tbody id="leaderboard-list">
          <tr><td colspan="3" style="text-align:center; color:var(--muted);">Cargando...</td></tr>
        </tbody>
      </table>
    </div>
  `;
  contentEl.innerHTML = html;

  // Listener para el botón de refrescar
  document.getElementById("btn-refresh-leaderboard").onclick = () => renderLeaderboardTab();

  // Pedir los datos a Firebase
  db.collection("leaderboard")
    .orderBy("level", "desc") // Ordenar por nivel (de mayor a menor)
    .limit(10) // Traer solo los 10 primeros
    .get()
    .then((querySnapshot) => {
      const listEl = document.getElementById("leaderboard-list");
      listEl.innerHTML = ""; // Limpiar el "Cargando..."

      if (querySnapshot.empty) {
        listEl.innerHTML = `<tr><td colspan="3" style="text-align:center; color:var(--muted);">El leaderboard está vacío. ¡Sé el primero en subir de nivel!</td></tr>`;
        return;
      }

      let position = 1;
      querySnapshot.forEach((doc) => {
        const player = doc.data();
        listEl.innerHTML += `
          <tr>
            <td><b>#${position}</b></td>
            <td>${escapeHtml(player.name)}</td>
            <td><b>${player.level}</b></td>
          </tr>
        `;
        position++;
      });
    })
    .catch((error) => {
      console.error("Error al leer el Leaderboard: ", error);
      const listEl = document.getElementById("leaderboard-list");
      listEl.innerHTML = `<tr><td colspan="3" style="text-align:center; color:var(--stat-fue);">Error al cargar los datos. Intenta de nuevo.</td></tr>`;
    });
}
// --- FIN DE LÓGICA DE LEADERBOARD ---
  // --- INICIALIZACIÓN ---
  checkMimoReset(); 
  checkHabitReset(); 
  checkMissionCooldowns(); 
  checkCompanion(); 
  checkAchievements(); 
  renderTabs();
  renderTab("Player");
  renderAll(); 
  checkDailyLogin(); // Comprobar la racha de conexión


  // --- Bucle de Fondo ---
  setInterval(() => {
    const tabActual = document.querySelector(".tab.active")?.textContent;
    checkMissionCooldowns();
    checkCompanion(); 
    checkMimoReset(); 
    
    if (tabActual === "Missions") renderTab("Missions");
    if (tabActual === "Player") renderTab("Player"); 
    if (tabActual === "Compañero") renderTab("Compañero"); 
    if (tabActual === "Casino") renderTab("Casino"); 
   // --- LÓGICA DE LEADERBOARD (NUEVO) ---

// Función para ENVIAR datos a Firebase
function updateLeaderboard(playerName, playerLevel) {
  if (!db) return; // No hacer nada si Firebase no se conectó

  // Usamos el nombre del jugador como ID único.
  // .set() crea el documento si no existe, o lo sobrescribe si ya existe.
  db.collection("leaderboard").doc(playerName).set({
    name: playerName,
    level: playerLevel
  })
  .then(() => {
    console.log("¡Puntuación actualizada en el Leaderboard!");
  })
  .catch((error) => {
    console.error("Error al escribir en el Leaderboard: ", error);
    // Opcional: registrar el error en el diario
    // state.player.diary.push(`(Error de conexión con el Leaderboard)`);
  });
}

// Función para LEER y RENDERIZAR la pestaña del Leaderboard
function renderLeaderboardTab() {
  if (!db) {
     contentEl.innerHTML = `<h2>🏆 Leaderboard</h2><p style="color:var(--stat-fue);">Error: No se pudo conectar a la base de datos de Firebase.</p>`;
     return;
  }

  let html = `<h2>🏆 Leaderboard (Top 10)</h2>
    <p style="color:var(--muted); margin-top: 4px;">¡Compite con tus amigos!</p>
    <button class="button" id="btn-refresh-leaderboard">Actualizar</button>
    <div class="table-wrapper" style="margin-top: 15px;">
      <table>
        <thead><tr><th>Pos.</th><th>Nombre</th><th>Nivel</th></tr></thead>
        <tbody id="leaderboard-list">
          <tr><td colspan="3" style="text-align:center; color:var(--muted);">Cargando...</td></tr>
        </tbody>
      </table>
    </div>
  `;
  contentEl.innerHTML = html;

  // Listener para el botón de refrescar
  document.getElementById("btn-refresh-leaderboard").onclick = () => renderLeaderboardTab();

  // Pedir los datos a Firebase
  db.collection("leaderboard")
    .orderBy("level", "desc") // Ordenar por nivel (de mayor a menor)
    .limit(10) // Traer solo los 10 primeros
    .get()
    .then((querySnapshot) => {
      const listEl = document.getElementById("leaderboard-list");
      listEl.innerHTML = ""; // Limpiar el "Cargando..."

      if (querySnapshot.empty) {
        listEl.innerHTML = `<tr><td colspan="3" style="text-align:center; color:var(--muted);">El leaderboard está vacío. ¡Sé el primero en subir de nivel!</td></tr>`;
        return;
      }

      let position = 1;
      querySnapshot.forEach((doc) => {
        const player = doc.data();
        listEl.innerHTML += `
          <tr>
            <td><b>#${position}</b></td>
            <td>${escapeHtml(player.name)}</td>
            <td><b>${player.level}</b></td>
          </tr>
        `;
        position++;
      });
    })
    .catch((error) => {
      console.error("Error al leer el Leaderboard: ", error);
      const listEl = document.getElementById("leaderboard-list");
      listEl.innerHTML = `<tr><td colspan="3" style="text-align:center; color:var(--stat-fue);">Error al cargar los datos. Intenta de nuevo.</td></tr>`;
    });
} 
  }, 30000); 
  
  </script>
</body>
</html>






